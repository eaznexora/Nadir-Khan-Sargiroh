<!DOCTYPE html>
<html lang="ur">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Category Management | Nadir Khan</title>
    <script>
      const API_BASE_URL = window.location.origin; 
    </script>

    <style>
        /* --- Keeping all your existing styles exactly as they are --- */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background-color: #fff; font-family: 'Times New Roman', serif; }
        .admin-header { text-align: center; padding: 15px 0; border-bottom: 1px solid #eee; }
        .admin-header h1 { font-size: 22px; font-weight: bold; }
        .category-bar { background: #444A25; color: white; padding: 8px 15px; display: flex; justify-content: space-between; align-items: center; }
        .category-bar .cat-name { font-size: 18px; font-weight: bold; text-transform: capitalize; }
        .category-bar .urdu-label { font-family: 'Jameel Noori Nastaleeq', serif; font-size: 20px; }
        .add-btn-wrapper { padding: 15px; }
        .main-add-btn { display: block; width: 100%; background: #7E816F; color: white; border: none; border-radius: 8px; padding: 12px; font-size: 18px; cursor: pointer; text-decoration: none; text-align: center; }
        .section-title { padding: 10px 15px; font-size: 18px; font-weight: bold; color: #333; border-bottom: 1px solid #eee; margin-top: 10px; }
        .post-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; padding: 15px; direction: ltr; }
        .grid-card { border-bottom: 1px solid #ddd; padding-bottom: 10px; }
        .grid-img { width: 100%; aspect-ratio: 1/1; object-fit: cover; border: 1px solid #ccc; }
        .grid-info { text-align: right; direction: rtl; margin-top: 8px; }
        .grid-title { font-size: 16px; font-weight: bold; margin-bottom: 2px; }
        .grid-date { font-size: 11px; color: #666; font-family: Arial; }
        .grid-actions { display: flex; justify-content: flex-end; gap: 12px; margin-top: 10px; direction: ltr; }
        .grid-actions img { width: 18px; height: 18px; cursor: pointer; }
        .no-posts { text-align: center; padding: 20px; color: #888; grid-column: span 2; }
        .main-header { position: relative; z-index: 10; background: transparent; }
        .brand-bar { background: #A1A58F; width: 100%; height: 120px; padding: 10px 0; display: flex; flex-direction: column; align-items: center; position: relative; }
        .brand-logo-container { width: 100%; display: flex; justify-content: center; margin-bottom: 2px; cursor: pointer; }
        .header-title-img { max-width: 90%; height: auto; object-fit: contain; }
        .divider-line { width: 90%; height: 1px; background: #818472; border: 1px solid #818472; margin: 5px auto; }
        .brand-subtitle { font-family: 'Trebuchet MS', sans-serif; font-weight: 700; font-size: 19px; text-align: center; text-transform: uppercase; color: #000000; text-shadow: 0px 2px 3px #A9B37C; margin-bottom: 5px; }
        .header-mid-border { width: 100%; height: 5px; background: #616357; }
        .nav-bar { background: #DDD0EA; width: 100%; display: flex; flex-direction: column; box-shadow: 0px 4px 4px rgba(0, 0, 0, 0.25); }
        .nav-top-row { display: flex; width: 100%; justify-content: space-between; align-items: center; padding: 5px 16px; height: 50px; direction: ltr; }
        .nav-title-admin { font-family: 'Times New Roman', serif; font-weight: 700; color: #4b2c61; font-size: 18px; }
        .nav-icon { width: 30px; height: 30px; cursor: pointer; }
    </style>
</head>
<body>

<header class="main-header">
    <div class="brand-bar">
        <div class="brand-logo-container" onclick="location.href='index.html'">
            <img src="/assets/images/Header Title.png" class="header-title-img">
        </div>
        <div class="divider-line"></div>
        <h1 class="brand-subtitle">NADIR KHAN SARGIROH URDU VOCABULARY</h1>
    </div>
    <div class="header-mid-border"></div>
    <div class="nav-bar">
        <div class="nav-top-row">
            <img src="/assets/icons/Back.svg" class="nav-icon" onclick="location.href='admin-index.html'" title="Visit Site">
            <span class="nav-title-admin">ADMINISTRATOR PANEL</span>
            <img src="/assets/icons/Logout.svg" class="nav-icon" onclick="location.href=`${API_BASE_URL}/api/logout`" title="Logout">
        </div>
    </div>
</header>

    <div class="category-bar">
        <span id="display-cat-en" class="cat-name">Category</span>
        <span class="urdu-label">تازہ بہ تازہ</span>
    </div>

    <div class="add-btn-wrapper">
        <button id="add-btn" class="main-add-btn">Add a new post</button>
    </div>

    <div class="section-title">Pinned Posts</div>
    <div id="pinned-grid" class="post-grid"></div>

    <div class="section-title">Recent Posts</div>
    <div id="recent-grid" class="post-grid"></div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const catType = urlParams.get('type') || 'all';

        document.getElementById('add-btn').onclick = () => {
            location.href = `admin-form.html?type=${catType}`;
        };

        async function loadCategoryPosts() {
            try {
                document.getElementById('display-cat-en').innerText = catType;

                // FIXED: Use credentials for auth
                const res = await fetch(`${API_BASE_URL}/api/posts?type=${catType}`, { credentials: 'include' });
                const posts = await res.json();

                const pinnedGrid = document.getElementById('pinned-grid');
                const recentGrid = document.getElementById('recent-grid');

                const pinnedPosts = posts.filter(p => p.isPinned);
                const regularPosts = posts.filter(p => !p.isPinned);

                const renderCard = (p) => {
                    const rawThumb = p.thumbnailUrl || (Array.isArray(p.imageUrl) ? p.imageUrl[0] : p.imageUrl) || '/assets/images/placeholder.png';
                    
                    // FIXED: Ensure absolute path for Railway images
                    const thumb = (rawThumb.startsWith('/assets/uploads')) ? `${API_BASE_URL}${rawThumb}` : rawThumb;

                    return `
                    <div class="grid-card">
                        <img src="${thumb}" class="grid-img" onerror="this.src='/assets/images/placeholder.png'">
                        <div class="grid-info">
                            <div class="grid-title">${p.title}</div>
                            <span class="grid-date">${p.date}</span>
                            <div class="grid-actions">
                                <img src="/assets/icons/${p.isPinned ? 'pin-active.svg' : 'pin-outline.svg'}" onclick="toggleField('${p._id}', 'isPinned', ${p.isPinned})">
                                <img src="/assets/icons/${p.isHidden ? 'eye-closed.svg' : 'eye-open.svg'}" onclick="toggleField('${p._id}', 'isHidden', ${p.isHidden})">
                                <img src="/assets/icons/delete.svg" onclick="deletePost('${p._id}')">
                                <img src="/assets/icons/edit.svg" onclick="location.href='admin-form.html?id=${p._id}'">
                            </div>
                        </div>
                    </div>`;
                };

                pinnedGrid.innerHTML = pinnedPosts.length ? pinnedPosts.map(renderCard).join('') : '<div class="no-posts">No pinned posts in this category.</div>';
                recentGrid.innerHTML = regularPosts.length ? regularPosts.map(renderCard).join('') : '<div class="no-posts">No recent posts found.</div>';

            } catch (err) { console.error("Failed to load category", err); }
        }

        async function toggleField(id, field, currentVal) {
            // FIXED: Added absolute URL and credentials
            const response = await fetch(`${API_BASE_URL}/api/posts/${id}`, {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ [field]: !currentVal }),
                credentials: 'include'
            });
            if (response.ok) loadCategoryPosts();
            else alert("Update failed. Session might have expired.");
        }

        async function deletePost(id) {
            if(confirm("Delete this post?")) {
                // FIXED: Added absolute URL and credentials
                const response = await fetch(`${API_BASE_URL}/api/posts/${id}`, { 
                    method: 'DELETE',
                    credentials: 'include'
                });
                if (response.ok) loadCategoryPosts();
                else alert("Delete failed.");
            }
        }

        loadCategoryPosts();
    </script>
</body>
</html>