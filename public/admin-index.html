<!DOCTYPE html>
<html lang="ur">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Administrator Panel | Nadir Khan</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background-color: #fff; font-family: 'Times New Roman', serif; }

        /* --- HEADER STYLES --- */
        .main-header { position: relative; z-index: 10; background: transparent; }
        .brand-bar {
            background: #A1A58F; width: 100%; height: 120px;
            padding: 10px 0; display: flex; flex-direction: column; align-items: center; position: relative;
        }
        .brand-logo-container { width: 100%; display: flex; justify-content: center; margin-bottom: 2px; cursor: pointer; }
        .header-title-img { max-width: 90%; height: auto; object-fit: contain; }
        .divider-line { width: 90%; height: 1px; background: #818472; border: 1px solid #818472; margin: 5px auto; }
        .brand-subtitle {
            font-family: 'Trebuchet MS', sans-serif; font-weight: 700; font-size: 19px;
            text-align: center; text-transform: uppercase; color: #000000;
            text-shadow: 0px 2px 3px #A9B37C; margin-bottom: 5px;
        }
        .header-mid-border { width: 100%; height: 5px; background: #616357; }

        /* --- NAVIGATION (LOGOUT INCLUDED) --- */
        .nav-bar {
            background: #DDD0EA; width: 100%; display: flex; flex-direction: column;
            box-shadow: 0px 4px 4px rgba(0, 0, 0, 0.25);
        }
        .nav-top-row {
            display: flex; width: 100%; justify-content: space-between; align-items: center; 
            padding: 5px 16px; height: 50px; direction: ltr; 
        }
        .nav-title-admin { font-family: 'Times New Roman', serif; font-weight: 700; color: #4b2c61; font-size: 18px; }
        .nav-icon { width: 30px; height: 30px; cursor: pointer; }

        .admin-header { text-align: center; padding: 15px 0; border-bottom: 1px solid #eee; }
        .admin-header h1 { font-size: 22px; font-weight: bold; }

        .add-btn-wrapper { padding: 15px; }
        .main-add-btn {
            display: block; width: 100%; background: #7E816F; color: white;
            border: none; border-radius: 8px; padding: 12px; font-size: 18px;
            cursor: pointer; text-decoration: none; text-align: center;
        }

        .section-bar {
            background: #444A25; color: white; padding: 8px 15px;
            display: flex; justify-content: space-between; align-items: center;
        }
        .section-bar span { font-size: 18px; font-weight: bold; }

        .post-card {
            display: flex; padding: 15px; border-bottom: 1px solid #ddd;
            gap: 15px; direction: ltr; align-items: flex-start;
        }
        .post-img { width: 130px; height: 130px; object-fit: cover; border: 1px solid #ccc; }
        
        .post-info { flex: 1; text-align: right; direction: rtl; }
        .post-title { font-size: 18px; font-weight: bold; margin-bottom: 5px; color: #000; }
        .post-date { font-size: 12px; color: #666; margin-bottom: 10px; display: block; font-family: Arial; }
        
        .actions { 
            display: flex; justify-content: flex-end; gap: 18px; 
            margin-top: 15px; direction: ltr; 
        }
        .actions img { width: 22px; height: 22px; cursor: pointer; }

        .category-list { padding: 10px 15px; }
        .cat-pill {
            display: flex; justify-content: space-between; align-items: center;
            background: #F1F1F1; margin-bottom: 8px; padding: 12px 18px;
            border-radius: 5px; text-decoration: none; color: #4F5240;
            direction: ltr; border: 1px solid #e0e0e0;
        }
        .cat-en { font-family: 'Times New Roman', serif; font-size: 18px; color: #5D604E; }
        .cat-ur { font-family: 'Jameel Noori Nastaleeq', serif; font-size: 20px; font-weight: bold; }

        .mgmt-footer { display: flex; justify-content: space-between; padding: 20px 15px; }
        .mgmt-link { font-size: 14px; font-weight: bold; cursor: pointer; text-decoration: none; }
        .add-cat { color: #2D5A27; }
        .rem-cat { color: #A63232; }
    </style>
</head>
<body>

<header class="main-header">
    <div class="brand-bar">
        <div class="brand-logo-container" onclick="location.href='index.html'">
            <img src="/assets/images/Header Title.png" class="header-title-img">
        </div>
        <div class="divider-line"></div>
        <h1 class="brand-subtitle">NADIR KHAN SARGIROH URDU VOCABULARY</h1>
    </div>
    <div class="header-mid-border"></div>
    <div class="nav-bar">
        <div class="nav-top-row">
            <img src="/assets/icons/Back.svg" class="nav-icon" onclick="location.href='index.html'" title="Visit Site">
            <span class="nav-title-admin">ADMINISTRATOR PANEL</span>
            <img src="/assets/icons/Logout.svg" class="nav-icon" onclick="location.href='/api/logout'" title="Logout">
        </div>
    </div>
</header>

<div class="add-btn-wrapper">
    <button class="main-add-btn" onclick="location.href='admin-form.html'">Add a new post</button>
</div>

<div class="section-bar">
    <span>Recently Uploaded</span>
    <span>تازہ بہ تازہ</span>
</div>
<div id="posts-container"></div>

<div class="section-bar">
    <span>Categories</span>
    <span>تازہ بہ تازہ</span>
</div>
<div class="category-list" id="cats-container"></div>

<div class="mgmt-footer">
    <span class="mgmt-link add-cat" onclick="addCategory()">Add a new category</span>
    <span class="mgmt-link rem-cat" onclick="removeCategory()">Remove a category</span>
</div>

<script>
    async function init() {
        try {
            const [pRes, cRes] = await Promise.all([
                fetch('/api/posts?limit=10'),
                fetch('/api/categories')
            ]);
            
            const posts = await pRes.json();
            const cats = await cRes.json();

            document.getElementById('posts-container').innerHTML = posts.map(p => {
                const thumb = p.thumbnailUrl || (Array.isArray(p.imageUrl) ? p.imageUrl[0] : p.imageUrl) || '/assets/images/placeholder.png';
                // FIXED: Check for correct icon names
                const pinIcon = p.isPinned ? 'pin-active.svg' : 'pin-outline.svg';
                const eyeIcon = p.isHidden ? 'eye-closed.svg' : 'eye-open.svg';

                return `
                <div class="post-card">
                    <img src="${thumb}" class="post-img" onerror="this.src='/assets/images/placeholder.png'">
                    <div class="post-info">
                        <div class="post-title">${p.title}</div>
                        <span class="post-date">${p.date}</span>
                        <div class="actions">
                            <img src="/assets/icons/${pinIcon}" onclick="toggleField('${p._id}', 'isPinned', ${p.isPinned})" title="Pin/Unpin">
                            <img src="/assets/icons/${eyeIcon}" onclick="toggleField('${p._id}', 'isHidden', ${p.isHidden})" title="Public/Private">
                            <img src="/assets/icons/delete.svg" onclick="deletePost('${p._id}')" title="Delete">
                            <img src="/assets/icons/edit.svg" onclick="location.href='admin-form.html?id=${p._id}'" title="Edit">
                        </div>
                    </div>
                </div>`;
            }).join('');

            document.getElementById('cats-container').innerHTML = cats.map(c => `
                <a href="admin-category.html?type=${c.nameEn}" class="cat-pill">
                    <span class="cat-en">${c.nameEn.charAt(0).toUpperCase() + c.nameEn.slice(1)}</span>
                    <span class="cat-ur">${c.nameUr}</span>
                </a>
            `).join('');
        } catch (err) { console.error("Dashboard failed to load", err); }
    }

    async function toggleField(id, field, currentVal) {
    try {
        const response = await fetch(`/api/posts/${id}`, {
            method: 'PUT', // Ensures compatibility with postController.updatePost
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ [field]: !currentVal })
        });

        if (response.ok) {
            init(); // Refreshes the dashboard to update icons
        } else {
            const err = await response.json();
            alert("Update failed: " + (err.error || "Unknown error"));
        }
    } catch (e) {
        console.error("Toggle request failed:", e);
    }
}

    async function deletePost(id) {
        if(confirm("Are you sure you want to delete this post?")) {
            await fetch(`/api/posts/${id}`, { method: 'DELETE' });
            init();
        }
    }

    async function addCategory() {
        const en = prompt("Enter Category Name (English):");
        const ur = prompt("Enter Category Name (Urdu):");
        if (en && ur) {
            const cleanEn = en.toLowerCase().trim().replace(/\s+/g, '-');
            await fetch('/api/categories', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ nameEn: cleanEn, nameUr: ur })
            });
            location.reload();
        }
    }

    async function removeCategory() {
        const name = prompt("Enter the EXACT English name of the category to remove:");
        if(name) {
            const res = await fetch('/api/categories');
            const cats = await res.json();
            const target = cats.find(c => c.nameEn === name.toLowerCase());
            if(target) {
                await fetch(`/api/categories/${target._id}`, { method: 'DELETE' });
                init();
            } else alert("Category not found.");
        }
    }

    init();
</script>
</body>
</html>